#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

// --- DEFINIÇÃO DA ESTRUTURA ---
typedef struct {
    char nome[30];
    char cor[10];
    int tropas;
} Territorio;

// Lista de missões pré-definidas (constante global para facilitar o acesso no sorteio)
const char* LISTA_MISSOES[] = {
    "Dominar todos os territorios",
    "Ter um territorio com 50 tropas",
    "Conquistar o primeiro territorio da lista",
    "Eliminar o exercito Branco",
    "Manter a paz (Nao atacar ninguem)"
};

// --- PROTÓTIPOS DAS FUNÇÕES ---
void cadastrarTerritorios(Territorio* mapa, int qtd);
void exibirMapa(Territorio* mapa, int qtd);
void atribuirMissao(char* destino, const char* missoes[], int totalMissoes);
int verificarMissao(char* missao, Territorio* mapa, int qtd);
void atacar(Territorio* atacante, Territorio* defensor);
void liberarMemoria(Territorio* mapa, char* missao);

// --- FUNÇÃO PRINCIPAL ---
int main() {
    Territorio* mapa;
    char* missaoJogador;
    int qtdTerritorios, opcao, idAtk, idDef;
    int jogoRodando = 1;

    srand(time(NULL)); // Semente para aleatoriedade

    printf("--- WAR ESTRUTURADO: DESAFIO FINAL ---\n");
    
    // 1. Alocação e Cadastro do Mapa
    printf("Quantos territorios no jogo? ");
    scanf("%d", &qtdTerritorios);

    // Alocação do vetor de estruturas
    mapa = (Territorio*) calloc(qtdTerritorios, sizeof(Territorio));
    if (mapa == NULL) { printf("Erro de memoria no mapa.\n"); return 1; }

    cadastrarTerritorios(mapa, qtdTerritorios);

    // 2. Alocação e Sorteio da Missão
    // Alocamos espaço suficiente para a maior string de missão
    missaoJogador = (char*) malloc(100 * sizeof(char)); 
    if (missaoJogador == NULL) { printf("Erro de memoria na missao.\n"); return 1; }

    // Passagem por referência do buffer 'missaoJogador'
    atribuirMissao(missaoJogador, LISTA_MISSOES, 5);

    // Exibe a missão apenas uma vez no início (Requisito de interface)
    printf("\n>>> SUA MISSAO SECRETA: %s <<<\n", missaoJogador);
    printf("Pressione ENTER para comecar...");
    getchar(); getchar(); // Pausa para leitura

    // 3. Loop do Jogo
    while (jogoRodando) {
        exibirMapa(mapa, qtdTerritorios);

        printf("\n1. Realizar Ataque\n2. Encerrar Jogo\nEscolha: ");
        scanf("%d", &opcao);

        if (opcao == 1) {
            printf("ID Atacante: "); scanf("%d", &idAtk);
            printf("ID Defensor: "); scanf("%d", &idDef);

            // Validação de índices
            if (idAtk > 0 && idAtk <= qtdTerritorios && idDef > 0 && idDef <= qtdTerritorios) {
                // Passagem de ponteiros para a função de ataque
                atacar(&mapa[idAtk-1], &mapa[idDef-1]);
                
                // Verifica vitória após o ataque
                if (verificarMissao(missaoJogador, mapa, qtdTerritorios)) {
                    printf("\n**************************************\n");
                    printf("  VITORIA! Voce cumpriu sua missao:\n");
                    printf("  %s\n", missaoJogador);
                    printf("**************************************\n");
                    jogoRodando = 0;
                }
            } else {
                printf("IDs invalidos.\n");
            }
        } else {
            jogoRodando = 0;
        }
    }

    // 4. Liberação de Memória
    liberarMemoria(mapa, missaoJogador);
    return 0;
}

// --- IMPLEMENTAÇÃO DAS FUNÇÕES ---

// Sorteia uma missão e copia para a memória alocada do jogador
void atribuirMissao(char* destino, const char* missoes[], int totalMissoes) {
    int indice = rand() % totalMissoes;
    strcpy(destino, missoes[indice]); // Copia a string sorteada para o destino
}

// Verifica se a condição de vitória foi atingida (Lógica simples para exemplo)
int verificarMissao(char* missao, Territorio* mapa, int qtd) {
    // Exemplo de lógica baseada na string da missão
    
    // Missão: Dominar todos (todos os territórios têm a mesma cor do primeiro)
    if (strcmp(missao, "Dominar todos os territorios") == 0) {
        char corDominante[10];
        strcpy(corDominante, mapa[0].cor);
        for (int i = 1; i < qtd; i++) {
            if (strcmp(mapa[i].cor, corDominante) != 0) return 0; // Se um for diferente, falhou
        }
        return 1; // Sucesso
    }

    // Missão: Ter um território com 50 tropas (Itera procurando a condição)
    if (strcmp(missao, "Ter um territorio com 50 tropas") == 0) {
        for (int i = 0; i < qtd; i++) {
            if (mapa[i].tropas >= 50) return 1;
        }
    }
    
    // Outras lógicas de missão podem ser implementadas aqui...
    return 0;
}

void atacar(Territorio* atacante, Territorio* defensor) {
    printf("\n--- Batalha: %s vs %s ---\n", atacante->nome, defensor->nome);

    if (strcmp(atacante->cor, defensor->cor) == 0) {
        printf("Fogo amigo nao permitido!\n");
        return;
    }

    // Simulação de dados (1 a 6)
    int dadoAtk = (rand() % 6) + 1;
    int dadoDef = (rand() % 6) + 1;
    printf("Dados: Atk [%d] vs Def [%d]\n", dadoAtk, dadoDef);

    if (dadoAtk > dadoDef) {
        printf("O atacante VENCEU!\n");
        strcpy(defensor->cor, atacante->cor); // Troca de dono
        int transferencia = atacante->tropas / 2;
        defensor->tropas = transferencia;
        atacante->tropas -= transferencia;
        printf("Territorio conquistado! %d tropas movidas.\n", transferencia);
    } else {
        printf("A defesa VENCEU!\n");
        if (atacante->tropas > 0) atacante->tropas--; // Penalidade
    }
}

void cadastrarTerritorios(Territorio* mapa, int qtd) {
    for (int i = 0; i < qtd; i++) {
        printf("\nTerritorio %d:\n", i + 1);
        printf("Nome: "); scanf(" %29[^\n]", mapa[i].nome);
        printf("Cor: "); scanf(" %9s", mapa[i].cor);
        printf("Tropas: "); scanf("%d", &mapa[i].tropas);
    }
}

void exibirMapa(Territorio* mapa, int qtd) {
    printf("\n--- SITUACAO ATUAL ---\n");
    for (int i = 0; i < qtd; i++) {
        printf("[%d] %-15s | %-10s | %d tropas\n", 
               i+1, mapa[i].nome, mapa[i].cor, mapa[i].tropas);
    }
}

// Libera tanto o vetor de struct quanto a string de missão
void liberarMemoria(Territorio* mapa, char* missao) {
    if (mapa != NULL) free(mapa);
    if (missao != NULL) free(missao);
    printf("\nMemoria liberada. Jogo encerrado.\n");
}
